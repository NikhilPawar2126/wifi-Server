<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>IoTwin Vision – Wi-Fi Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MQTT over WebSocket -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <!-- Font -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap">

  <style>
    :root {
      --bg: #f5f5f7;
      --card: #ffffff;
      --border: #e5e5ea;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --danger: #ef4444;
      --success: #16a34a;
    }

    body {
      font-family: "SF Pro Display", sans-serif;
      background: radial-gradient(circle at top, #ffffff, #f3f4f6 65%);
    }

    .card {
      background: var(--card);
      border-radius: 24px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.06);
    }

    .input {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #d4d4d8;
      background: #fafafa;
      padding: 10px 12px;
    }

    .btn-primary {
      width: 100%;
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 500;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      border: none;
    }

    .badge {
      display: inline-flex;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 11px;
      color: var(--muted);
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #9ca3af;
    }

    .status-dot.ok {
      background: var(--success);
    }

    .status-dot.bad {
      background: var(--danger);
    }

    /* Radar */
    .radar-wrapper {
      position: relative;
      width: 220px;
      height: 220px;
      margin: 0 auto;
    }

    .radar-circle {
      position: absolute;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      inset: 0;
      margin: auto;
    }

    .radar-sweep {
      position: absolute;
      width: 50%;
      height: 2px;
      background: linear-gradient(to right, rgba(37, 99, 235, 0.7), transparent);
      top: 50%;
      left: 50%;
      transform-origin: left center;
      animation: sweep 3s linear infinite;
    }

    @keyframes sweep {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .radar-dot {
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

  <div class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- LEFT PANEL -->
    <section class="card p-6 flex flex-col gap-5">

      <header>
        <div class="badge">
          <span class="status-dot ok"></span>
          <span>IoTwin Vision • Setup</span>
        </div>
        <h1 class="text-xl font-semibold mt-2">Configure Wi-Fi for ESP32</h1>
        <p class="text-xs text-gray-500">
          Send Wi-Fi credentials to ESP32 via MQTT.
        </p>
      </header>

      <!-- Wi-Fi Form -->
      <form id="wifiForm" class="flex flex-col gap-4 mt-2">
        <div>
          <label class="text-xs font-medium">Wi-Fi Name (SSID)</label>
          <input id="ssid" type="text" class="input" placeholder="Home_WiFi" required />
        </div>

        <div>
          <label class="text-xs font-medium">Password</label>
          <input id="password" type="password" class="input" placeholder="Enter Wi-Fi password" required />
        </div>

        <button id="sendBtn" class="btn-primary mt-2">Send Wi-Fi to Device</button>
        <p id="sendStatus" class="text-xs text-gray-500"></p>
      </form>

      <!-- Disconnect -->
      <button id="disconnectBtn"
        class="mt-1 w-full rounded-full px-4 py-2.5 text-sm font-medium bg-red-500 text-white">
        Disconnect Device Wi-Fi
      </button>
      <p id="disconnectStatus" class="text-xs text-gray-500"></p>
    </section>

    <!-- RIGHT PANEL -->
    <section class="card p-6 flex flex-col gap-4">

      <header class="flex justify-between">
        <div>
          <h2 class="text-base font-semibold">Device & Wi-Fi Radar</h2>
          <p class="text-[11px] text-gray-500">Real-time device monitoring</p>
        </div>
        <div class="text-right text-[11px] text-gray-500">
          <div id="mqttStatus">MQTT: connecting…</div>
          <div id="deviceStatus">Device: waiting…</div>
        </div>
      </header>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <!-- Radar -->
        <div class="radar-wrapper">
          <div class="radar-circle"></div>
          <div class="radar-circle" style="inset:18px"></div>
          <div class="radar-circle" style="inset:36px"></div>
          <div class="radar-circle" style="inset:54px"></div>
          <div class="radar-sweep"></div>
          <div id="radarDots"></div>
        </div>

        <!-- Status Info -->
        <div class="flex flex-col gap-3 text-xs text-gray-600">

          <div class="flex justify-between">
            <span>Device online</span>
            <span id="onlineBadge" class="badge">
              <span class="status-dot"></span>
              <span>Unknown</span>
            </span>
          </div>

          <div>
            <span class="text-[11px]">Connected Wi-Fi</span>
            <div id="wifiName" class="font-medium">—</div>
          </div>

          <div>
            <span class="text-[11px]">Signal strength</span>
            <div id="rssiText" class="text-[11px]">— dBm</div>
          </div>

          <div>
            <span class="text-[11px]">Last update</span>
            <div id="lastUpdate">—</div>
          </div>

          <div>
            <span class="text-[11px]">Networks detected</span>
            <ul id="networkList" class="space-y-1 max-h-24 overflow-y-auto"></ul>
          </div>
        </div>
      </div>

      <!-- Scan Button -->
      <button id="scanBtn"
        class="mt-2 w-full rounded-full px-4 py-2.5 text-sm font-medium bg-blue-500 text-white">
        Start Scan
      </button>
    </section>
  </div>

  <!-- ############################ -->
  <!-- ####### JAVASCRIPT ######### -->
  <!-- ############################ -->
  <script>
    // Topics
    const WIFI_TOPIC = "Equanimous/AR/wifi";
    const STATUS_TOPIC = "Equanimous/AR/status";
    const SCAN_TOPIC = "Equanimous/AR/scan";
    const DISCONNECT_TOPIC = "Equanimous/AR/disconnect";

    // HiveMQ WebSocket Broker
    const BROKER_URL = "wss://broker.hivemq.com:8884/mqtt";

    let mqttClient;
    let scanning = false;
    let lastStatusTime = Date.now();

    // UI elements
    const mqttStatusEl = document.getElementById("mqttStatus");
    const deviceStatusEl = document.getElementById("deviceStatus");
    const wifiNameEl = document.getElementById("wifiName");
    const rssiTextEl = document.getElementById("rssiText");
    const lastUpdateEl = document.getElementById("lastUpdate");
    const onlineBadge = document.getElementById("onlineBadge");
    const networkListEl = document.getElementById("networkList");
    const radarDotsEl = document.getElementById("radarDots");

    const sendStatusEl = document.getElementById("sendStatus");
    const disconnectStatusEl = document.getElementById("disconnectStatus");
    const scanBtn = document.getElementById("scanBtn");

    /* ------------ Helper UI Updates ------------- */
    function setOnlineBadge(status) {
      const dot = onlineBadge.querySelector(".status-dot");
      const text = onlineBadge.querySelector("span:last-child");

      dot.classList.remove("ok", "bad");

      if (status) {
        dot.classList.add("ok");
        text.textContent = "Online";
      } else {
        dot.classList.add("bad");
        text.textContent = "Offline";
      }
    }

    function updateLastUpdate() {
      lastUpdateEl.textContent = new Date().toLocaleTimeString();
    }

    /* ------------ MQTT Connect ------------- */
    function connectMQTT() {
      mqttClient = mqtt.connect(BROKER_URL, {
        clientId: "WebDash_" + Math.random().toString(16).slice(2),
        reconnectPeriod: 2000,
      });

      mqttClient.on("connect", () => {
        mqttStatusEl.textContent = "MQTT: connected";

        mqttClient.subscribe(STATUS_TOPIC);
        mqttClient.subscribe(SCAN_TOPIC);
      });

      mqttClient.on("message", (topic, payload) => {
        const msg = JSON.parse(payload.toString());

        // STATUS UPDATE
        if (topic === STATUS_TOPIC) {
          lastStatusTime = Date.now(); // reset timeout timer
          setOnlineBadge(msg.online);
          wifiNameEl.textContent = msg.wifi_ssid || "—";
          rssiTextEl.textContent = msg.rssi + " dBm";
          deviceStatusEl.textContent = msg.online ? "Device: online" : "Device: offline";
          updateLastUpdate();
        }

        // SCAN RESULT
        if (topic === SCAN_TOPIC && scanning) {
          renderNetworks(msg.networks);
        }
      });

      mqttClient.on("close", () => {
        mqttStatusEl.textContent = "MQTT: disconnected";
      });
    }
    connectMQTT();

    /* ------------ Offline Timeout Detection ------------- */
    setInterval(() => {
      if (Date.now() - lastStatusTime > 5000) {
        deviceStatusEl.textContent = "Device: offline";
        setOnlineBadge(false);
        wifiNameEl.textContent = "—";
        rssiTextEl.textContent = "— dBm";
      }
    }, 1000);

    /* ------------ Render Networks ------------- */
    function renderNetworks(networks = []) {
      networkListEl.innerHTML = "";
      radarDotsEl.innerHTML = "";

      if (networks.length === 0) {
        networkListEl.innerHTML =
          `<li class="text-[11px] text-gray-400">No networks found</li>`;
        return;
      }

      networks.forEach((net, i) => {
        const li = document.createElement("li");
        li.className = "flex justify-between text-[11px] text-gray-600";
        li.innerHTML = `<span>${net.ssid}</span> <span>${net.rssi} dBm</span>`;
        networkListEl.appendChild(li);

        // Radar dot
        const angle = (i / networks.length) * Math.PI * 2;
        const r = Math.min(1, Math.abs(net.rssi) / 80);

        const dot = document.createElement("div");
        dot.className = "radar-dot";
        dot.style.left = 50 + r * 40 * Math.cos(angle) + "%";
        dot.style.top = 50 + r * 40 * Math.sin(angle) + "%";
        radarDotsEl.appendChild(dot);
      });
    }

    /* ------------ SCAN BUTTON ------------- */
    scanBtn.addEventListener("click", () => {
      if (!mqttClient.connected) return alert("MQTT not connected!");

      if (!scanning) {
        scanning = true;
        scanBtn.textContent = "Stop Scan";

        networkListEl.innerHTML = `<li class="text-[11px] text-gray-400">Scanning...</li>`;

        mqttClient.publish(SCAN_TOPIC, JSON.stringify({ action: "scan" }));
      } else {
        scanning = false;
        scanBtn.textContent = "Start Scan";

        networkListEl.innerHTML = "";
        radarDotsEl.innerHTML = "";
      }
    });

    /* ------------ SEND WI-FI CREDENTIALS ------------- */
    document.getElementById("wifiForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const ssid = document.getElementById("ssid").value.trim();
      const pass = document.getElementById("password").value.trim();

      if (!ssid || !pass) {
        sendStatusEl.textContent = "Enter SSID and Password!";
        sendStatusEl.style.color = "red";
        return;
      }

      if (!mqttClient.connected) {
        sendStatusEl.textContent = "MQTT not connected!";
        sendStatusEl.style.color = "red";
        return;
      }

      mqttClient.publish(WIFI_TOPIC, JSON.stringify({ ssid, password: pass }));

      sendStatusEl.textContent = "Wi-Fi credentials sent!";
      sendStatusEl.style.color = "green";
    });

    /* ------------ DISCONNECT DEVICE ------------- */
    document.getElementById("disconnectBtn").addEventListener("click", () => {
      if (!mqttClient.connected) {
        disconnectStatusEl.textContent = "MQTT not connected!";
        disconnectStatusEl.style.color = "red";
        return;
      }

      mqttClient.publish(DISCONNECT_TOPIC, JSON.stringify({ action: "disconnect" }));

      disconnectStatusEl.textContent = "Disconnect command sent!";
      disconnectStatusEl.style.color = "orange";
    });
  </script>

</body>
</html>
